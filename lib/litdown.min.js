(function(){function encode(e){for(var t=0;t<encodings.length;t++){var n=new RegExp(encodings[t][0],"g");e=e.replace(n,"&"+encodings[t][1]+";")}return e}function merge(e){for(var t,n,r=1;r<arguments.length;r++){t=arguments[r];for(n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}function normalize(e){return e.toLowerCase().replace(/[^\w+]/g,"-")}function flow(e,t,n){t||(t=process.stdout.columns-1||80),n||(n="");var r=n,i=r.length;return e instanceof Array&&(e=e.join(" ")),e.match(/^\* /)&&(n+="  "),e.split(" ").forEach(function(e){i+e.length+1<t?(r+=e+" ",i+=e.length+1):(r+="\n"+n+e+" ",i=n.length+e.length+1)}),r+="\n"}function canary(){return Math.floor(Math.random()*Math.pow(2,50)).toString(36)}function header_state(e,t,n,r){var i=normalize(t);if(null==r.blocks.contents[i]&&(r.blocks.contents[i]="",r.blocks.order.push(i)),e<=n.maxlevel){for(var o=1;e>o;o++)r.toc.md+="    ";r.toc.md+="* ["+t+"](#"+i+")\n"}return r}function header_html(e,t,n){var r=normalize(t),i='<a name="'+r+'">'+t+"</a>";return n&&(i+=' <a href="#'+normalize(n.header)+'">'+n.top+"</a>"),i="<h"+e+">"+i+"</h"+e+">\n"}function link_state(e,t,n,r){return t&&t.match(/^#/)&&(t=t.replace(/^#/,""),n&&n.match(/^save:/)&&null==r.files.contents[t]&&(r.files.contents[t]="",r.files.mode[t]=n.replace(/^save:/,""),r.files.order.push(t))),r}function link_html(e,t,n){t&&t.match(/^#/)&&(t="#"+normalize(t.replace(/^#/,"")));var r='<a href="'+t+'"';return n&&(r+=' title="'+n+'"'),r+=">"+e+"</a>"}function code_state(e,t){var n=t.blocks.order[t.blocks.order.length-1];return t.blocks.contents[n]||(t.blocks.contents[n]=e),t}function code_html(e,t,n){e=e.replace(/\n+$/,"");var r="<pre><code";return t&&n&&(r+=' class="'+n+t+'"'),r+=">"+encode(e)+"\n</code></pre>\n"}function cli(argv){function find(e){for(var t={files:[],dirs:[],stat:{}},n=fs.readdirSync(e),r=0;r<n.length;r++)if(!n[r].match(/^\./)){var i=path.join(e,n[r]),o=fs.statSync(i);if(o.isDirectory()){t.dirs.push(i);for(var s=find(i),a=0;a<s.files.length;a++)t.stat[s.files[a]]=s.stat[s.files[a]],t.files.push(s.files[a]);for(var a=0;a<s.dirs.length;a++)t.dirs.push(s.dirs[a])}else t.stat[i]=o,t.files.push(i)}return t}function mkpath(e,t){e=path.resolve(e),t=t||function(){},fs.mkdir(e,function(n){n?"ENOENT"===n.code?mkpath(path.dirname(e),function(n){n?t(n):mkpath(e,t)}):t("EEXIST"===n.code?null:n):t(null)})}function write_file(d,n,f,m){var fn=path.join(n,f);if(m){if(!m.match(/^[0-7]{3}$/))throw new Error('Invalid file mode "'+m+'"! Must be three octal digits.');m=eval("0"+m)}else m=420;mkpath(path.dirname(fn),function(e){if(e)throw e;fs.writeFile(fn,d,{mode:m},function(e){if(v("  "+fn),e)throw e})})}function exists(e){try{fs.writeFileSync(e,"",{flag:"wx"})}catch(t){return t&&"EEXIST"===t.code?!0:!1}}function B(){console.log("Backends\n  Supported: "+cfg.backend.supported.join(", ")+"\n  Installed: "+cfg.backend.installed.join(", ")+"\n  Preferred: "+cfg.backend.preferred.join(", ")+"\n  Selected:  "+cfg.backend.selected)}function S(){console.log("Syntax highlighters\n  Supported: "+cfg.highlight.supported.join(", ")+"\n  Preferred: "+cfg.highlight.preferred.join(", ")+"\n  Selected:  "+cfg.highlight.selected)}function rmext(e){return e.replace(/\.js$/,"")}function v_(e,t,n){t>=n&&console.log(e)}function v(e){v_(e,cfg.verbose,1)}function vv(e){v_(e,cfg.verbose,2)}var fs=require("fs"),path=require("path"),cfg={verbose:1,encoding:"utf8",backend:{plugins:path.join(__dirname,"backend"),preferred:["commonmark","marked","markdown-it"]},highlight:{plugins:path.join(__dirname,"highlight"),preferred:["highlightjs-cdn","none"]},json:!1,mode:"extract"};if(cfg.backend.supported=fs.readdirSync(cfg.backend.plugins).map(rmext),cfg.backend.supported.length<1)throw new Error("No backend plugins!");cfg.backend.installed=cfg.backend.supported.filter(function(e){var t;try{t=require.resolve(e)}catch(n){}return t});for(var i=0;i<cfg.backend.preferred.length;i++){var n=cfg.backend.preferred[i];cfg.backend.installed.indexOf(n)>=0&&(cfg.backend.selected=n,i=cfg.backend.preferred.length)}if(cfg.highlight.supported=fs.readdirSync(cfg.highlight.plugins).map(rmext),cfg.highlight.supported.length<1)throw new Error("No highlight plugins!");cfg.highlight.selected=cfg.highlight.preferred[0];for(var usage='\n# Usage\n\n```\nlitdown -x [options] file\nlitdown -c [options] directory\n```\n\n# Options\n\n```\n-h, --help   Show usage\n-v           Increase verbosity\n-q           Disable output\n```\n\n## Mode options\n\n```\n-x   Extract a Markdown file to a directory (default)\n-c   Create a Markdown file from files in directory\n```\n\n## Extract options\n\n```\n-l               Save internal state to "litdown.json"\n-b name[,name]   Preferred backend(s) (default: '+cfg.backend.preferred.join(",")+")\n-B               Show backend selection (use after -b to check)\n-s name[,name]   Preferred syntax highlighter (default: "+cfg.highlight.preferred.join(",")+")\n-S               Show syntax highlighter selection (use after -s to check)\n```\n",args=[],i=0;i<argv.length;i++){var s=argv[i];if("-h"==s||"--help"==s)console.log(usage),process.exit(0);else if("-v"==s)cfg.verbose++;else if("-q"==s)cfg.verbose=0;else if("-x"==s)cfg.mode="extract";else if("-c"==s)cfg.mode="create";else if("-l"==s)cfg.json=!0;else if("-b"==s){var a=argv[i+1];a||(a=""),a=a.split(/,/);for(var b=[],j=0;j<a.length;j++){var n=a[j];if(!n||""==n)return B(),0;cfg.backend.supported.indexOf(n)<0?(console.log('ERROR: The "'+n+'" backend is not supported.'),process.exit(1)):cfg.backend.installed.indexOf(n)<0?(console.log('ERROR: The "'+n+'" backend is not installed. Install it via `npm install -g '+n+"`."),process.exit(1)):b.push(n)}cfg.backend.preferred=b.slice(0),cfg.backend.selected=cfg.backend.preferred[0],i++}else{if("-B"==s)return B(),0;if("-s"==s){var a=argv[i+1];a||(a=""),a=a.split(/,/);for(var b=[],j=0;j<a.length;j++){var n=a[j];if(!n||""==n)return S(),0;cfg.highlight.supported.indexOf(n)<0?(console.log('ERROR: The "'+n+'" syntax highlighter is not supported.'),process.exit(1)):b.push(n)}cfg.highlight.preferred=b.slice(0),cfg.highlight.selected=cfg.highlight.preferred[0],i++}else{if("-S"==s)return S(),0;args.push(s)}}}if(vv("cfg = "+JSON.stringify(cfg,null,"	")),args.length<1)return console.log(usage),1;if(cfg.backend.installed.length<1&&(console.log("ERROR: No backend modules installed! Please install one or more of: "+cfg.backend.supported.join(", ")+".\n"+usage),process.exit(1)),"extract"==cfg.mode){var f=args[0];v(f);var n=path.basename(f,".md");return fs.readFile(f,{encoding:cfg.encoding},function(e,t){if(e)throw"EISDIR"==e.code&&(console.log('ERROR: "'+f+'" is a directory! Perhaps you meant to use -c?'),process.exit(1)),e;var r=path.join(cfg.backend.plugins,cfg.backend.selected);r=require(r);var i=path.join(cfg.highlight.plugins,cfg.highlight.selected);i=require(i);var o=litdown(t,{backend:r,highlight:i});o.cfg=cfg,fs.mkdir(n,function(e){if(e)throw"EEXIST"==e.code&&(console.log('ERROR: Directory "'+n+'" exists!\n'),process.exit(1)),e;cfg.json&&write_file(JSON.stringify(o,null,"	")+"\n",n,"litdown.json"),write_file(t,n,n+".md"),write_file(o.html,n,n+".html"),write_file(o.readme,n,"README.md"),o.files.order.forEach(function(e){write_file(o.files.contents[e],n,e,o.files.mode[e])})})}),0}if("create"==cfg.mode){var d=args[0],f=path.basename(d)+".md";v(f),exists(f)&&(console.log('ERROR: File "'+f+'" exists!'),process.exit(1));for(var list=find(d),files=list.files,output="# Files\n\n",re=new RegExp("^"+d+"/"),i=0;i<files.length;i++){var fn=files[i].replace(re,""),mode=(list.stat[files[i]].mode-32768).toString(8);"644"==mode&&(mode=""),output+="* ["+fn+"](#"+fn+' "save:'+mode+'")\n'}for(var i=0;i<files.length;i++){var fn=files[i].replace(re,"");output+="\n## "+fn+"\n\n```\n";var d=fs.readFileSync(files[i],{encoding:"utf8"});d=d.replace(/```/g,'_"_backticks"'),output+=d,output=output.replace(/\n$/,"")+"\n```\n",v("  "+files[i])}return output+="\n",fs.writeFileSync(f,output),0}throw new Error('Invalid mode "'+cfg.mode+'"!')}function litdown(e,t){try{t=t?merge({},litdown.defaults,t):litdown.defaults,this.state={readme:e,toc:{md:"# "+t.toc.header+"\n\n"},blocks:{contents:{_backticks:"```",_tab:"	"},order:[]},files:{contents:{},order:[],mode:{}}};var n=t.backend;this.state=n.parse(e,this.state,t),this.state.toc.md+="\n",this.state.readme=this.state.toc.md+this.state.readme,this.state.files.order.forEach(function(e){for(var t,n=normalize(e),r=this.state.blocks.contents[n]||"",i=r,o=new RegExp('_"([^"]+)"'),s=canary();null!==(t=o.exec(r));){var a=normalize(t[1]);if(a==n)throw new Error('Circular template label "'+a+'" detected in "'+e+'" file at index "'+t.index+'"');i=this.state.blocks.contents[a],i||(i="_"+s+t[1]+s),r=r.replace(o,i)}r=r.replace(new RegExp(s,"g"),'"'),this.state.files.contents[e]=r+"\n"}),this.state=n.render(this.state,t),this.state.html=this.state.html.replace(/_&quot;_tab&quot;/g,"	").replace(/_&quot;_backticks&quot;/g,"```").replace(new RegExp('<code class="'+t.lang_prefix+'nohighlight">',"g"),'<code class="nohighlight">'),this.state.html=this.state.toc.html+this.state.html,this.state.html=t.html.header+this.state.html+t.html.footer,this.state.html=t.highlight(this.state.html),delete this.state.f;var r=this.state;return this.state={},r.opt=t,r}catch(i){if("MODULE_NOT_FOUND"==i.code){var o=/'([^']*)'/.exec(i.message);i.message+=". Install it via `npm install -g "+o[1]+"`.\n"}if(t.silent)return"<p>ERROR:</p><pre>"+encode(i.message,!0)+"</pre>";throw i}}var encodings=[["&","amp"],["<","lt"],[">","gt"],['"',"quot"]];litdown.options=litdown.setOptions=function(e){return merge(litdown.defaults,e),litdown},litdown.defaults={silent:!1,toc:{maxlevel:2,header:"Contents",top:"^"},html:{header:"<!DOCTYPE html>\n<html>\n<head>\n<style>\n	code{\n		background-color: #f0f0f0;\n		padding: 0px 2px;\n		border: 1px solid #c0c0c0;\n	}\n	pre code{\n		display: block;\n	}\n	pre{\n		tab-size: 4;\n		white-space: pre-wrap;\n	}\n	a{\n		text-decoration: none;\n	}\n</style>\n</head>\n<body>\n",footer:"	</body>\n</html>\n"},lang_prefix:"lang-",f:{normalize:normalize,encode:encode,canary:canary,header_state:header_state,header_html:header_html,link_state:link_state,link_html:link_html,code_state:code_state,code_html:code_html}},litdown.state={},litdown.cli=cli,"undefined"!=typeof module&&"object"==typeof exports?module.exports=litdown:"function"==typeof define&&define.amd?define(function(){return litdown}):this.litdown=litdown}).call(function(){return this||("undefined"!=typeof window?window:global)}());